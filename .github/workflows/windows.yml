name: Setup Android Environment on Windows

on:
  push:
    branches:
      - master

jobs:
  setup-android:
    runs-on: windows-latest

    steps:
      - name: Disable UAC (No Restart)
        run: |
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "EnableLUA" -Value 0
        shell: pwsh

      - name: Install SDK and Set Environment Variables
        run: |
          # Download the command line tools
          Invoke-WebRequest -Uri "https://dl.google.com/android/repository/commandlinetools-win-8512546_latest.zip" -OutFile "commandlinetools.zip"
          Expand-Archive -Path "commandlinetools.zip" -DestinationPath "$env:USERPROFILE\AppData\Local\Android\Sdk\cmdline-tools"

          # Move the extracted folder to the correct location
          Move-Item "$env:USERPROFILE\AppData\Local\Android\Sdk\cmdline-tools\cmdline-tools" "$env:USERPROFILE\AppData\Local\Android\Sdk\cmdline-tools\latest"

          # Set ANDROID_HOME environment variable
          setx ANDROID_HOME "$env:USERPROFILE\AppData\Local\Android\Sdk" /M

          # Add SDK tools to the PATH
          setx PATH "$env:PATH;$env:ANDROID_HOME\cmdline-tools\latest\bin;$env:ANDROID_HOME\platform-tools;$env:ANDROID_HOME\emulator" /M

          # Refresh environment variables
          $env:ANDROID_HOME = [System.Environment]::GetEnvironmentVariable("ANDROID_HOME", "Machine")
          $env:PATH += ";$env:ANDROID_HOME\cmdline-tools\latest\bin;$env:ANDROID_HOME\platform-tools;$env:ANDROID_HOME\emulator"
        shell: pwsh

      - name: Install and Setup Intel HAXM
        run: |
          sdkmanager --install "extras;intel;Hardware_Accelerated_Execution_Manager"
          cd $env:ANDROID_HOME\extras\intel\Hardware_Accelerated_Execution_Manager
          .\silent_install.bat
        shell: pwsh

      - name: Install Latest SDK Images
        run: |
          sdkmanager --install "system-images;android-33;default;x86_64"
        shell: pwsh

      - name: Create AVD Emulator
        run: |
          avdmanager create avd -n MyEmulatorAPI33 -k "system-images;android-33;default;x86_64" -d "pixel"
        shell: pwsh

      - name: Get List of AVDs
        run: |
          cd $env:ANDROID_HOME\emulator
          .\emulator -list-avds
        shell: pwsh
